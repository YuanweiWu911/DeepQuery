<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Query Interface</title>
    <link rel="stylesheet" href="styles.css"> <!-- 引入样式表 -->
    <style>
        /* 保留之前的样式 */
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
        }

        input,
        button {
            padding: 5px;
            margin: 5px;
        }

        #ai-response {
            border: 1px solid #444;
            padding: 10px;
            margin-top: 5px;
            height: 450px;
            overflow-y: scroll;
            position: relative; /* 为按钮定位提供相对参考 */
        }

        .user-question {
            background-color: blue;
            color: white;
            font-weight: bold;
        }

        .ai-thinking {
            background-color: white;
            color: gray;
        }

        .ai-response-normal {
            background-color: #eee;
            color: black;
        }

        /* 新增样式，设置Markdown渲染后的默认字号为9px */
        .user-question p,
        .ai-response-normal p,
        .ai-thinking p {
            font-size: 14px;
        }

        .input-container {
            text-align: center; /* 使内容居中 */
            margin-top: 5px; /* 上外边距可选 */
        }

        select {
            margin: 0 auto; /* 下拉框在容器中居中 */
        }

        #ai-response:empty::before {
            content: attr(placeholder); /* 如果 div 为空，显示占位符 */
        }

        /* 新增样式，用于将按钮定位到 textarea 内部右下角 */
        .textarea-container {
            position: relative;
            display: inline-block;
        }

        .textarea-container textarea {
            padding-right: 40px; /* 为按钮留出空间 */
        }

        .textarea-container button {
            position: absolute;
            bottom: 5px;
            right: 5px;
            margin: 0;
        }

        /* 新增样式，用于定位 new chat 按钮到 ai-response 内部左下角 */
        #new-chat-button {
            position: absolute;
            top: 5px;
            right: 5px;
            margin: 3px;
            /* 设置按钮的高度为当前字体大小的1倍，即1行字符的高度 */
            height: 1.2em; 
            /* 可以根据需要设置按钮的行高，使其文本垂直居中 */
            line-height: 1.1em; 
            /* 调整内边距，让按钮看起来更美观 */
            padding: 0 5px; 
        }

        /* 新增样式，用于定位 Enter 按钮 */
        #onclick {
            margin: 3px;
            /* 设置按钮的高度为当前字体大小的1倍，即1行字符的高度 */
            height: 1.2em; 
            /* 可以根据需要设置按钮的行高，使其文本垂直居中 */
            line-height: 1.1em; 
            /* 调整内边距，让按钮看起来更美观 */
            padding: 0 5px; 
        }
    </style>
</head>

<body>
    <h2 style="font-size: 20px; text-align: center;">Remote DeepSeek-R1</h2>

    <div class="input-container">
        <!-- 添加模型选择下拉框 -->
        <select id="model-select">
            <option value="deepseek-r1:latest">deepseek-r1:latest</option>
            <option value="deepseek-r1:32b" selected>deepseek-r1:32b</option>
            <option value="deepseek-r1:70b">deepseek-r1:70b</option>
        </select>
    </div>

    <!-- <h2>System outputs:</h2> -->
    <pre id="result"></pre>

    <!--  <h1>AI Response:</h1>  -->
    <div id="ai-response" placeholder="What can I do for you..." contenteditable="true">
        <!-- 新增 new chat 按钮 -->
        <button id="new-chat-button" onclick="newChat()">New Chat</button>
    </div>

    <div style="text-align: center; margin-top: 5px;" class="input-container">
        <div class="textarea-container">
            <textarea id="prompt" rows="5" cols="80" placeholder="请输入你的问题，回车键发送..."></textarea>
            <button onclick="sendQuery()">Enter</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let context = "";  // 用于存储对话上下文
        // 获取 textarea 元素
        const textarea = document.getElementById('prompt');
        // 为 textarea 添加按键事件监听器
        textarea.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // 阻止换行
                sendQuery(); // 触发查询
            }
        });

        async function sendQuery() {
            const prompt = document.getElementById('prompt').value; // 获取输入值
            const selectedModel = document.getElementById('model-select').value; // 获取选择的模型
            if (!prompt.trim()) { // 检查是否为空
                alert("Prompt cannot be empty!");
                return;
            }

            const response = await fetch('/query', { // 确保这里是 '/query'
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt, context, model: selectedModel }), // 将prompt、上下文和模型包装为JSON对象
            });

            const result = await response.json(); // 解析 JSON 响应
            if (result.error) {
                document.getElementById('result').innerText = result.error; // 显示错误
                document.getElementById('ai-response').innerText = ''; // 清空 AI 对话框
            } else {
                document.getElementById('result').innerText = 'Prompt submitted successfully!'; // 显示提示消息
                const aiResponseDiv = document.getElementById('ai-response');
                // 创建用户问题元素
                const userQuestion = document.createElement('div');
                userQuestion.classList.add('user-question');
                userQuestion.innerHTML = `${marked.parse('User')} ${marked.parse(prompt)}`;
                aiResponseDiv.appendChild(userQuestion);

                // 处理 AI 回复
                const aiResponseText = result.response;
                const thinkingStartIndex = aiResponseText.indexOf('<think>');
                const thinkingEndIndex = aiResponseText.indexOf('</think>');
                if (thinkingStartIndex !== -1 && thinkingEndIndex !== -1) {
                    // 创建 AI 思考部分元素
                    const aiThinking = document.createElement('div');
                    aiThinking.classList.add('ai-thinking');
                    const thinkingText = aiResponseText.substring(thinkingStartIndex + 7, thinkingEndIndex);
                    // 使用marked渲染思考部分的Markdown内容
                    aiThinking.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(thinkingText)}`;
                    aiResponseDiv.appendChild(aiThinking);

                    // 创建 AI 正常回复部分元素
                    const aiNormalResponse = document.createElement('div');
                    aiNormalResponse.classList.add('ai-response-normal');
                    const normalResponseText = aiResponseText.substring(thinkingEndIndex + 8);
                    // 使用marked渲染正常回复部分的Markdown内容
                    aiNormalResponse.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(normalResponseText)}`;
                    aiResponseDiv.appendChild(aiNormalResponse);
                } else {
                    // 没有思考部分，直接创建 AI 正常回复部分元素
                    const aiNormalResponse = document.createElement('div');
                    aiNormalResponse.classList.add('ai-response-normal');
                    // 使用marked渲染正常回复部分的Markdown内容
                    aiNormalResponse.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(aiResponseText)}`;
                    aiResponseDiv.appendChild(aiNormalResponse);
                }

                // 更新上下文
                context = result.context;
            }
        }

        // 新增 newChat 函数
        async function newChat() {
            try {
                const response = await fetch('/new-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    context = ""; // 清空对话历史
                    const aiResponseDiv = document.getElementById('ai-response');
                    aiResponseDiv.innerHTML = '<button id="new-chat-button" onclick="newChat()">New Chat</button>'; // 清空 AI 对话框内容并保留按钮
                }
            } catch (error) {
                console.error('Error resetting chat:', error);
            }
        }

        // 监听 ai-response 的滚动事件，更新 new chat 按钮位置
        const aiResponseDiv = document.getElementById('ai-response');
        aiResponseDiv.addEventListener('scroll', function () {
            const newChatButton = document.getElementById('new-chat-button');
            newChatButton.style.bottom = 5 + aiResponseDiv.scrollTop + 'px';
        });
    </script>
</body>

</html>
