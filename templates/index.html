<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Query Interface</title>
    <link rel="stylesheet" href="static/styles.css">
    <script src="https://unpkg.com/turndown@7.1.1/dist/turndown.js"></script>
</head>

<body>
    <h2 class="page-title">Remote DeepSeek-R1</h2>

    <div class="input-container">
        <button id="new-chat-button" onclick="newChat()">New Chat</button>
        <select id="model-select">
            <option value="deepseek-r1:latest">deepseek-r1:7b</option>
            <option value="deepseek-r1:32b" selected>deepseek-r1:32b</option>
            <option value="deepseek-r1:70b">deepseek-r1:70b</option>
        </select>
    </div>

    <div id="ai-response" placeholder="What can I do for you..." contenteditable="true"></div>

    <div class="input-container">
        <div class="textarea-container">
            <textarea id="prompt" rows="5" cols="80" placeholder="请输入你的问题，回车键发送..."></textarea>
            <button id="send-button" onclick="sendQuery()">Enter</button>
            <!-- 新增 Save 按钮 -->
            <button id="save-button" onclick="saveMessages()">Save</button>
            <button id="markdown-button" onclick="saveAsMarkdown()">Markdown</button>
            <!-- 新增 search on/off 按钮 -->
            <button id="search-toggle" class="off" onclick="toggleSearch()">Search</button>
            <!-- 新增 Reason 按钮 -->
            <button id="reason-toggle" class="off" onclick="toggleReason()">Reason</button>
        </div>
    </div>

    <!-- 新增 thinking 图标 -->
    <div id="thinking-icon" style="display: none;">
        <img src="static/thinking.gif" alt="Thinking...">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let context = "";
        let isSearchOn = false;  // 新增变量，用于记录 search on/off 按钮的状态
        let isReasonOn = false;  // 新增变量，用于记录 reason on/off 按钮的状态
        const textarea = document.getElementById('prompt');
        const sendButton = document.getElementById('send-button');
        const searchToggle = document.getElementById('search-toggle');
        const reasonToggle = document.getElementById('reason-toggle'); // 获取 Reason 按钮
        const saveButton = document.getElementById('save-button'); // 获取 Save 按钮
        const thinkingIcon = document.getElementById('thinking-icon'); // 获取 thinking 图标

        // 监听文本框的 keydown 事件
        textarea.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendQuery();
            }
        });

        // 建立WebSocket连接
        const socket = new WebSocket('ws://localhost:8765');

        socket.addEventListener('open', (event) => {
            console.log('WebSocket connection established');  // 新增日志记录
        });
    
        socket.addEventListener('message', (event) => {
            console.log('Received message:', event.data);  // 新增日志记录
            if (event.data === "start") {
                thinkingIcon.style.display = "block";
            } else if (event.data === "end") {
                thinkingIcon.style.display = "none";
            }
        });
    
        socket.addEventListener('error', (event) => {
            console.error('WebSocket error:', event);  // 新增错误处理
        });

        // 发送查询的函数
        async function sendQuery() {
            const prompt = document.getElementById('prompt').value;
            const selectedModel = document.getElementById('model-select').value;
            if (!prompt.trim()) {
                alert("Prompt cannot be empty!");
                return;
            }

            let web_context = "";  // 初始化 web_context

            // 根据 search on/off 按钮的状态，设置 web_context 的值
            if (isSearchOn) {
                try {
                    const searchResponse = await fetch('/web_search', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt: prompt })
                    });
                    const searchData = await searchResponse.json();
                    web_context = searchData.web_context;
                } catch (error) {
                    console.error('Search failed:', error);
                }
            }
        
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt, context, model: selectedModel, search_toggle: isSearchOn }),  // 确保传递 isSearchOn 的值
                });
        
                const result = await response.json();
                if (result.error) {
                    document.getElementById('ai-response').innerText = result.error;
                } else {
                    const aiResponseDiv = document.getElementById('ai-response');
                    const userQuestion = document.createElement('div');
                    userQuestion.classList.add('user-question');
                    userQuestion.innerHTML = `${marked.parse('User')} ${marked.parse(prompt)}`;
                    aiResponseDiv.appendChild(userQuestion);
        
                    const aiResponseText = result.response;
                    const thinkingStartIndex = aiResponseText.indexOf('<think>');
                    const thinkingEndIndex = aiResponseText.indexOf('</think>');
                    if (thinkingStartIndex !== -1 && thinkingEndIndex !== -1) {
                        // 仅当 Reason 按钮被按下时，才输出 ThinkingText
                        if (isReasonOn) {
                            const aiThinking = document.createElement('div');
                            aiThinking.classList.add('ai-thinking');
                            const thinkingText = aiResponseText.substring(thinkingStartIndex + 7, thinkingEndIndex);
                            aiThinking.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(thinkingText)}`;
                            aiResponseDiv.appendChild(aiThinking);
                        }
                        const aiNormalResponse = document.createElement('div');
                        aiNormalResponse.classList.add('ai-response-normal');
                        const normalResponseText = aiResponseText.substring(thinkingEndIndex + 8);
                        aiNormalResponse.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(normalResponseText)}`;
                        aiResponseDiv.appendChild(aiNormalResponse);

                    } else {
                        const aiNormalResponse = document.createElement('div');
                        aiNormalResponse.classList.add('ai-response-normal');
                        aiNormalResponse.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(aiResponseText)}`;
                        aiResponseDiv.appendChild(aiNormalResponse);
                    }
        
                    context = result.context;
                }
            } catch (error) {
                console.error('Error sending query:', error);
            }
        }

        // 开始新聊天的函数
        async function newChat() {
            try {
                const response = await fetch('/new-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    context = "";
                    const aiResponseDiv = document.getElementById('ai-response');
                    aiResponseDiv.innerHTML = '';
                }
            } catch (error) {
                console.error('Error resetting chat:', error);
            }
        }

        // 新增函数，用于切换 search on/off 按钮的状态
        function toggleSearch() {
            isSearchOn = !isSearchOn;
            if (isSearchOn) {
                searchToggle.classList.remove('off');
                searchToggle.classList.add('on');
            } else {
                searchToggle.classList.remove('on');
                searchToggle.classList.add('off');
            }
        }

        // 新增函数，用于切换 reason on/off 按钮的状态
        function toggleReason() {
            isReasonOn = !isReasonOn;
            if (isReasonOn) {
                reasonToggle.classList.remove('off');
                reasonToggle.classList.add('on');
            } else {
                reasonToggle.classList.remove('on');
                reasonToggle.classList.add('off');
            }
        }

        // 新增函数，用于保存 all_messages 为 JSON 文件
        async function saveMessages() {
            try {
                const response = await fetch('/get-all-messages', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const allMessages = await response.json();
                const jsonData = JSON.stringify(allMessages, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'all_messages.json';
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error saving messages:', error);
            }
        }
        // 新增函数，用于将 ai_response 中的内容以 Markdown 格式保存
        async function saveAsMarkdown() {
            const aiResponseDiv = document.getElementById('ai-response');
            const aiResponseText = aiResponseDiv.innerHTML;

            // 创建 TurndownService 实例                                         
            const turndownService = new TurndownService();
            // 将 HTML 转换为 Markdown
            const markdownText = turndownService.turndown(aiResponseText);
        
            // 创建一个 Blob 对象，将内容保存为 Markdown 文件
            const blob = new Blob([markdownText], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
    
            // 创建一个 <a> 元素，用于触发下载
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ai_response.md';
            a.click();
    
            // 释放 URL 对象
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>
