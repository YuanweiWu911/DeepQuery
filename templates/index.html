<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Query Interface</title>
    <link rel="stylesheet" href="static/styles.css">
</head>

<body>
    <h2 class="page-title">Remote DeepSeek-R1</h2>

    <div class="input-container">
        <button id="new-chat-button" onclick="newChat()">New Chat</button>
        <select id="model-select">
            <option value="deepseek-r1:latest">deepseek-r1:latest</option>
            <option value="deepseek-r1:32b" selected>deepseek-r1:32b</option>
            <option value="deepseek-r1:70b">deepseek-r1:70b</option>
        </select>
    </div>

    <div id="ai-response" placeholder="What can I do for you..." contenteditable="true"></div>

    <div class="input-container">
        <div class="textarea-container">
            <textarea id="prompt" rows="5" cols="80" placeholder="请输入你的问题，回车键发送..."></textarea>
            <button id="send-button" onclick="sendQuery()">Enter</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let context = "";
        const textarea = document.getElementById('prompt');
        const sendButton = document.getElementById('send-button');

        // 监听文本框的 keydown 事件
        textarea.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendQuery();
            }
        });

        // 发送查询的函数
        async function sendQuery() {
            const prompt = document.getElementById('prompt').value;
            const selectedModel = document.getElementById('model-select').value;
            if (!prompt.trim()) {
                alert("Prompt cannot be empty!");
                return;
            }

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt, context, model: selectedModel }),
                });

                const result = await response.json();
                if (result.error) {
                    document.getElementById('ai-response').innerText = result.error;
                } else {
                    const aiResponseDiv = document.getElementById('ai-response');
                    const userQuestion = document.createElement('div');
                    userQuestion.classList.add('user-question');
                    userQuestion.innerHTML = `${marked.parse('User')} ${marked.parse(prompt)}`;
                    aiResponseDiv.appendChild(userQuestion);

                    const aiResponseText = result.response;
                    const thinkingStartIndex = aiResponseText.indexOf('<think>');
                    const thinkingEndIndex = aiResponseText.indexOf('</think>');
                    if (thinkingStartIndex !== -1 && thinkingEndIndex !== -1) {
                        const aiThinking = document.createElement('div');
                        aiThinking.classList.add('ai-thinking');
                        const thinkingText = aiResponseText.substring(thinkingStartIndex + 7, thinkingEndIndex);
                        aiThinking.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(thinkingText)}`;
                        aiResponseDiv.appendChild(aiThinking);

                        const aiNormalResponse = document.createElement('div');
                        aiNormalResponse.classList.add('ai-response-normal');
                        const normalResponseText = aiResponseText.substring(thinkingEndIndex + 8);
                        aiNormalResponse.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(normalResponseText)}`;
                        aiResponseDiv.appendChild(aiNormalResponse);
                    } else {
                        const aiNormalResponse = document.createElement('div');
                        aiNormalResponse.classList.add('ai-response-normal');
                        aiNormalResponse.innerHTML = `${marked.parse(selectedModel)} ${marked.parse(aiResponseText)}`;
                        aiResponseDiv.appendChild(aiNormalResponse);
                    }

                    context = result.context;
                }
            } catch (error) {
                console.error('Error sending query:', error);
            }
        }

        // 开始新聊天的函数
        async function newChat() {
            try {
                const response = await fetch('/new-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    context = "";
                    const aiResponseDiv = document.getElementById('ai-response');
                    aiResponseDiv.innerHTML = '';
                }
            } catch (error) {
                console.error('Error resetting chat:', error);
            }
        }
    </script>
</body>

</html>